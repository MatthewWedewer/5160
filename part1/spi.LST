C51 COMPILER V9.54   SPI                                                                   10/09/2015 15:24:44 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE SPI
OBJECT MODULE PLACED IN spi.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE spi.c OPTIMIZE(8,SPEED) DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "main.h"
   2          #include "port.h"
   3          
   4          
   5          
   6          uint8_t SPI_transfer(uint8_t data_input, uint8_t *data_output)
   7          {
   8   1        uint8_t test, timeout;
   9   1        timeout = 0;
  10   1        SPDAT = data_input;
  11   1        do
  12   1        {
  13   2          test = SPSTA; // SPDAT?
  14   2          timeout++;
  15   2        }while(((test & 0xF0) != 0xF0)&&(timeout!=0));
  16   1        if(timeout != 0)
  17   1        {
  18   2          *data_output = SPDAT;
  19   2          timeout = (test & 0x70);
  20   2        }
  21   1        else
  22   1        {
  23   2          timeout = TIMEOUT_ERROR;
  24   2        }
  25   1        return timeout;
  26   1      }
  27          
  28          
  29          uint8_t send_command(uint8_t cmd, uint32_t argum)
  30          {
  31   1        uint8_t error_flag, send_val, return_val, index;
  32   1        if(cmd < 64)
  33   1        {
  34   2          send_val = 0x40 | cmd;
  35   2          error_flag = SPI_transfer(send_val, &return_val);
  36   2          index = 24;
  37   2          while((error_flag == NO_ERRORS)&(index<25))
  38   2          {
  39   3            send_val = (uint8_t)(argum >> index);
  40   3            error_flag = SPI_transfer(send_val, &return_val);
  41   3            index -= 8;
  42   3          }
  43   2          if(cmd == 0)
  44   2            send_val = 0x95;
  45   2          else if(cmd == 8)
  46   2            send_val = 0x87;
  47   2          else
  48   2            send_val = 0x01;
  49   2          if(error_flag == NO_ERRORS)
  50   2            error_flag = SPI_transfer(send_val, &return_val);
  51   2          if(error_flag == NO_ERRORS)
  52   2            error_flag = SPI_ERROR;
  53   2        }
  54   1        else
  55   1          error_flag = ILLEGAL_COMMAND;
C51 COMPILER V9.54   SPI                                                                   10/09/2015 15:24:44 PAGE 2   

  56   1        return error_flag;
  57   1      }
  58          
  59          
  60          uint8_t get_response(uint8_t num_bytes, uint8_t *array_out)
  61          {
  62   1        uint8_t timeout, error_flag, recieve_value, index;
  63   1        timeout = 0;
  64   1        error_flag = NO_ERRORS;
  65   1        do
  66   1        {
  67   2          error_flag = SPI_transfer(0xFF, &recieve_value);
  68   2          timeout++;
  69   2        }while((timeout!=0)&&(error_flag == NO_ERRORS)&&(recieve_value == 0xFF));
  70   1        *array_out = recieve_value;
  71   1        if(timeout == 0)
  72   1          error_flag = TIMEOUT_ERROR;
  73   1        else if(error_flag != NO_ERRORS)
  74   1          error_flag = SPI_ERROR;
  75   1        else if((recieve_value != 0x01)||(recieve_value != 0x00))
  76   1          error_flag = SPI_ERROR;
  77   1        else if(num_bytes > 1)
  78   1        {
  79   2          for(index = 1; index < num_bytes; index++)
  80   2          {
  81   3            SPI_transfer(0xFF, & recieve_value);
  82   3            array_out[index] = recieve_value;
  83   3          }
  84   2        }
  85   1        SPI_transfer(0xFF, &recieve_value);
  86   1        return error_flag;
  87   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    288    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
