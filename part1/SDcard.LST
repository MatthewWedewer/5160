C51 COMPILER V9.54   SDCARD                                                                10/12/2015 21:10:21 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE SDCARD
OBJECT MODULE PLACED IN SDcard.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SDcard.c OPTIMIZE(8,SPEED) DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "main.h"
   2          #include "port.h"
   3          #include "SDcard.h"
   4          #include "spi.h"
   5          
   6          uint8_t SDcard_init()
   7          {
   8   1        uint8_t return_value[5];
   9   1        uint8_t error_flag, error_status, index, timeout;
  10   1        uint32_t ACMD41_argum = 0x40000000;
  11   1        
  12   1        
  13   1        
  14   1        ncs = 1;
  15   1        for(index = 0; index < 10; index++)
  16   1        {
  17   2          SPI_transfer(0xFF, return_value);
  18   2        }
  19   1        
  20   1        
  21   1        // Send CMD0
  22   1        ncs = 0;
  23   1        error_flag = send_command(CMD0, 0);
  24   1        if(error_flag == NO_ERRORS)
  25   1        {
  26   2          error_flag = get_response(1, return_value);
  27   2        }
  28   1        if(error_flag == NO_ERRORS)
  29   1        {
  30   2          if(return_value[0] != 0x01)
  31   2          {
  32   3            error_flag = WRONG_RESPONCE;
  33   3          }
  34   2        }
  35   1        ncs = 1;
  36   1        
  37   1        
  38   1        
  39   1        // Send CMD8
  40   1        if(error_flag == NO_ERRORS)
  41   1        {
  42   2          ncs = 0;
  43   2          error_flag = send_command(CMD8, 0x000001AA);
  44   2        }
  45   1        if(error_flag == NO_ERRORS)
  46   1        {
  47   2          error_flag = get_response(5, return_value);
  48   2        }
  49   1        if(return_value[0] == 0x05)
  50   1          error_flag = WRONG_RESPONCE;
  51   1        else if(return_value[0] != 0x01)
  52   1          error_flag = FAIL_SDINIT;
  53   1        ncs = 1;
  54   1        
  55   1        
C51 COMPILER V9.54   SDCARD                                                                10/12/2015 21:10:21 PAGE 2   

  56   1        
  57   1        // SEND CMD58
  58   1        if(error_flag == NO_ERRORS)
  59   1        {
  60   2          ncs = 0;
  61   2          error_flag = send_command(58, 0);
  62   2        }
  63   1        if(error_flag == NO_ERRORS)
  64   1        {
  65   2          error_flag = get_response(5, return_value);
  66   2        }
  67   1        if(return_value[0] == 0x01)
  68   1        {
  69   2          error_flag = WRONG_RESPONCE;
  70   2        }
  71   1      //  voltage_range = return_value[2];
  72   1        
  73   1        
  74   1        // Send ACMD41
  75   1        if(error_flag == NO_ERRORS)
  76   1        {
  77   2          ncs = 0;
  78   2          error_flag = send_command(55, 0);
  79   2        }
  80   1        if(error_flag == NO_ERRORS)
  81   1        {
  82   2          timeout = 0;
  83   2          do
  84   2          {
  85   3            error_flag = get_response(1, return_value);
  86   3            timeout++;
  87   3          }while(!(error_flag == 0x01 || error_flag == 0x00) && timeout != 0);
  88   2          if(timeout == 0)
  89   2            error_flag = TIMEOUT_ERROR;     
  90   2        }
  91   1        timeout = 0;
  92   1        if(error_flag == NO_ERRORS)
  93   1        {
  94   2          do
  95   2          {
  96   3            error_flag = send_command(41, ACMD41_argum);
  97   3            if(error_flag == NO_ERRORS)
  98   3            {
  99   4              error_flag = get_response(1, return_value);
 100   4            }
 101   3            timeout++;
 102   3          }while(return_value[0] != 0x00 && timeout != 0 && error_flag == NO_ERRORS);
 103   2          if(timeout == 0)
 104   2          {
 105   3            error_flag = TIMEOUT_ERROR;
 106   3          }
 107   2        }
 108   1        ncs = 1;
 109   1        
 110   1        
 111   1        // Send CMD51
 112   1        if(error_flag == NO_ERRORS)
 113   1        {
 114   2          ncs = 0;
 115   2          error_flag = send_command(58, 0);
 116   2        }
 117   1        if(error_flag == NO_ERRORS)
C51 COMPILER V9.54   SDCARD                                                                10/12/2015 21:10:21 PAGE 3   

 118   1        {
 119   2          error_flag = get_response(5, return_value);
 120   2        }
 121   1        
 122   1        ncs = 1;
 123   1        if(return_value[1] & 0xC0) //bit 31 and 30 are set
 124   1        {
 125   2          //High Capacity
 126   2        }
 127   1        else if(return_value[1] & 0x80) // only bit 31 is set
 128   1        {
 129   2          //Standard Capacity
 130   2          error_flag = WRONG_SDCARD;
 131   2        }
 132   1        else
 133   1        {
 134   2          error_flag = WRONG_RESPONCE;
 135   2        }
 136   1        
 137   1        
 138   1        
 139   1        
 140   1        
 141   1        
 142   1        
 143   1        
 144   1        
 145   1        
 146   1        
 147   1        
 148   1        
 149   1        
 150   1        
 151   1        
 152   1        
 153   1        
 154   1        
 155   1        
 156   1        
 157   1        if(error_flag != NO_ERRORS) // LED4 is the error light and this should also be redundent.
 158   1        {
 159   2          LED4 = 0;
 160   2        }
 161   1        ncs = 1; // should not be needed but just in case
 162   1        
 163   1        
 164   1          
 165   1        
 166   1        
 167   1        return error_flag; 
 168   1      }
*** WARNING C280 IN LINE 9 OF SDcard.c: 'error_status': unreferenced local variable


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    335    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.54   SDCARD                                                                10/12/2015 21:10:21 PAGE 4   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
